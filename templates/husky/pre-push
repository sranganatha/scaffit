#!/usr/bin/env sh
. "$(dirname -- "$0")/_/husky.sh"

# Pre-push hook
# This script runs before pushing to remote

echo "ğŸš€ Running pre-push checks..."

# Check if we're in a git repository
if ! git rev-parse --git-dir > /dev/null 2>&1; then
  echo "âŒ Not in a git repository"
  exit 1
fi

# Get current branch
CURRENT_BRANCH=$(git branch --show-current)
echo "ğŸ“‹ Current branch: $CURRENT_BRANCH"

# Skip checks for certain branches
{{#if skipBranches}}
SKIP_BRANCHES="{{SKIP_BRANCHES}}"
if echo "$SKIP_BRANCHES" | grep -q "$CURRENT_BRANCH"; then
  echo "â­ï¸  Skipping checks for branch: $CURRENT_BRANCH"
  exit 0
fi
{{/if}}

# Run comprehensive tests
{{#if includeJest}}
echo "ğŸ§ª Running Jest tests..."
if ! npm run test -- --coverage --passWithNoTests; then
  echo "âŒ Jest tests failed"
  exit 1
fi
echo "âœ… Jest tests passed"
{{/if}}

{{#if includeVitest}}
echo "ğŸ§ª Running Vitest tests..."
if ! npm run test -- --run --coverage; then
  echo "âŒ Vitest tests failed"
  exit 1
fi
echo "âœ… Vitest tests passed"
{{/if}}

{{#if includePlaywright}}
echo "ğŸ­ Running Playwright tests..."
if ! npm run test:e2e -- --reporter=line; then
  echo "âŒ Playwright tests failed"
  exit 1
fi
echo "âœ… Playwright tests passed"
{{/if}}

# Build verification
{{#if includeBuildCheck}}
echo "ğŸ—ï¸  Running build verification..."
if ! npm run build; then
  echo "âŒ Build failed"
  exit 1
fi
echo "âœ… Build verification passed"
{{/if}}

# Type checking
{{#if includeTypeScript}}
echo "ğŸ“ Running TypeScript type check..."
if ! npx tsc --noEmit; then
  echo "âŒ TypeScript type check failed"
  exit 1
fi
echo "âœ… TypeScript type check passed"
{{/if}}

# Linting
{{#if includeESLint}}
echo "ğŸ”§ Running ESLint..."
if ! npx eslint . --ext .ts,.tsx,.js,.jsx --max-warnings 0; then
  echo "âŒ ESLint checks failed"
  exit 1
fi
echo "âœ… ESLint checks passed"
{{/if}}

# Formatting
{{#if includePrettier}}
echo "ğŸ¨ Running Prettier..."
if ! npx prettier --check .; then
  echo "âŒ Prettier formatting issues found"
  echo "ğŸ’¡ Run 'npx prettier --write .' to fix"
  exit 1
fi
echo "âœ… Prettier checks passed"
{{/if}}

# Security audit
{{#if includeSecurityCheck}}
echo "ğŸ”’ Running security audit..."
if ! npm audit --audit-level moderate; then
  echo "âŒ Security vulnerabilities found"
  echo "ğŸ’¡ Run 'npm audit fix' to fix issues"
  exit 1
fi
echo "âœ… Security audit passed"
{{/if}}

# Dependency check
{{#if includeDependencyCheck}}
echo "ğŸ“¦ Checking dependencies..."
if ! npm ls --depth=0; then
  echo "âŒ Dependency issues found"
  exit 1
fi
echo "âœ… Dependencies check passed"
{{/if}}

# Bundle size check
{{#if includeBundleSizeCheck}}
echo "ğŸ“Š Checking bundle size..."
if ! npm run bundle-size-check; then
  echo "âŒ Bundle size check failed"
  exit 1
fi
echo "âœ… Bundle size check passed"
{{/if}}

# Performance check
{{#if includePerformanceCheck}}
echo "âš¡ Running performance check..."
if ! npm run performance-check; then
  echo "âŒ Performance check failed"
  exit 1
fi
echo "âœ… Performance check passed"
{{/if}}

echo "ğŸ‰ All pre-push checks passed!"
echo "ğŸš€ Ready to push to $CURRENT_BRANCH"
exit 0