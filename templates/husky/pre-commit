#!/usr/bin/env sh
. "$(dirname -- "$0")/_/husky.sh"

# Pre-commit hook
# This script runs before each commit

echo "ğŸ” Running pre-commit checks..."

# Check if we're in a git repository
if ! git rev-parse --git-dir > /dev/null 2>&1; then
  echo "âŒ Not in a git repository"
  exit 1
fi

# Staged files
STAGED_FILES=$(git diff --cached --name-only --diff-filter=ACM)

if [ -z "$STAGED_FILES" ]; then
  echo "â„¹ï¸  No staged files to check"
  exit 0
fi

echo "ğŸ“ Checking staged files:"
echo "$STAGED_FILES"

# Linting checks
{{#if includeESLint}}
echo "ğŸ”§ Running ESLint..."
if ! npx eslint $STAGED_FILES --fix; then
  echo "âŒ ESLint checks failed"
  exit 1
fi
echo "âœ… ESLint checks passed"
{{/if}}

# Formatting checks
{{#if includePrettier}}
echo "ğŸ¨ Running Prettier..."
if ! npx prettier --check $STAGED_FILES; then
  echo "âŒ Prettier formatting issues found"
  echo "ğŸ’¡ Run 'npx prettier --write $STAGED_FILES' to fix"
  exit 1
fi
echo "âœ… Prettier checks passed"
{{/if}}

# Type checking
{{#if includeTypeScript}}
echo "ğŸ“ Running TypeScript type check..."
if ! npx tsc --noEmit; then
  echo "âŒ TypeScript type check failed"
  exit 1
fi
echo "âœ… TypeScript type check passed"
{{/if}}

# Test checks
{{#if includeJest}}
echo "ğŸ§ª Running Jest tests..."
if ! npm run test -- --passWithNoTests; then
  echo "âŒ Jest tests failed"
  exit 1
fi
echo "âœ… Jest tests passed"
{{/if}}

{{#if includeVitest}}
echo "ğŸ§ª Running Vitest tests..."
if ! npm run test -- --run; then
  echo "âŒ Vitest tests failed"
  exit 1
fi
echo "âœ… Vitest tests passed"
{{/if}}

# Build checks
{{#if includeBuildCheck}}
echo "ğŸ—ï¸  Running build check..."
if ! npm run build; then
  echo "âŒ Build failed"
  exit 1
fi
echo "âœ… Build check passed"
{{/if}}

# Security checks
{{#if includeSecurityCheck}}
echo "ğŸ”’ Running security audit..."
if ! npm audit --audit-level moderate; then
  echo "âŒ Security vulnerabilities found"
  echo "ğŸ’¡ Run 'npm audit fix' to fix issues"
  exit 1
fi
echo "âœ… Security audit passed"
{{/if}}

# Commit message validation
{{#if includeCommitlint}}
echo "ğŸ“ Validating commit message..."
if ! npx commitlint --edit $1; then
  echo "âŒ Commit message validation failed"
  exit 1
fi
echo "âœ… Commit message validation passed"
{{/if}}

echo "ğŸ‰ All pre-commit checks passed!"
exit 0